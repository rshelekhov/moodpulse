generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())

  telegramId   BigInt @unique
  username     String?
  firstName    String?
  lastName     String?
  languageCode String?

  timezone          String  @default("Europe/Moscow")
  timezoneSetByUser Boolean @default(false)
  reminderEnabled   Boolean @default(true)
  reminderTime      String  @default("21:00")
  takingMedications Boolean @default(false)

  reminderNextAt          DateTime?
  reminderLastSentLocalDate String?
  reminderSnoozeUntil     DateTime?
  reminderSkipLocalDate   String?

  alertsEnabled     Boolean          @default(true)
  alertsSensitivity AlertSensitivity @default(MEDIUM)
  alertsSnoozeUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  checkins    Checkin[]
  alertStates AlertState[]

  @@index([reminderEnabled, reminderNextAt])
}

model Checkin {
  id String @id @default(uuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Mood scale from -3 (depressed) to +3 (hypomania)
  // 0 is neutral
  mood Int

  // Energy scale from 1 (low energy) to 5 (high energy)
  energy Int

  // Sleep duration in hours
  sleepDuration Float
  sleepQuality  SleepQuality

  // Anxiety level from 0 (no anxiety) to 3 (extreme anxiety)
  anxiety Int

  // Irritability level from 0 (not irritable) to 3 (extremely irritable)
  irritability Int

  medicationTaken MedicationStatus

  note String?

  createdAt DateTime @default(now())

  // Local date (YYYY-MM-DD) in the user's timezone
  localDate String

  @@unique([userId, localDate])
  @@index([userId, createdAt])
}

enum SleepQuality {
  POOR
  FAIR
  GOOD
}

enum MedicationStatus {
  TAKEN
  SKIPPED
  NOT_APPLICABLE
}

enum AlertSensitivity {
  LOW
  MEDIUM
  HIGH
}

model AlertState {
  id            String    @id @default(uuid())
  userId        String
  ruleId        String
  lastSentAt    DateTime?
  cooldownUntil DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, ruleId])
}
